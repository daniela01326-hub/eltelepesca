<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Producto — eltelepesca</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/es.js"></script>
  <script>dayjs.locale('es');</script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .line-clamp-2{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    .scrollbar-thin{scrollbar-width:thin}.scrollbar-thin::-webkit-scrollbar{height:8px;width:8px}
  </style>
</head>
<body class="bg-slate-50 text-slate-800" x-data="detailApp()" x-init="init()">
  <header class="sticky top-0 z-30 backdrop-blur bg-white/80 border-b border-slate-200">
    <div class="max-w-5xl mx-auto px-4 py-3 flex items-center gap-3">
      <div class="flex-1">
        <a href="./" class="text-xl font-bold tracking-tight">eltelepesca</a>
        <p class="text-xs text-slate-500">Tienda con retiro en local</p>
      </div>
      <a href="./" class="text-sky-700 underline">← Volver a la tienda</a>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 py-6">
    <template x-if="loading"><p class="text-sm text-slate-500">Cargando…</p></template>
    <template x-if="loadError"><p class="text-sm text-rose-600">⚠️ No pude leer <code>data/productos.xlsx</code>. Verificá que exista esa ruta en el deploy.</p></template>
    <template x-if="!loading && !product && !loadError"><p class="text-sm text-rose-600">⚠️ No se encontró el producto solicitado.</p></template>

    <template x-if="product">
      <div class="grid md:grid-cols-2 gap-6">
        <div class="bg-white rounded-2xl shadow-sm border overflow-hidden relative">
          <img :src="product.imagen || ('https://picsum.photos/seed/'+product.__id+'/1200/900')"
               class="w-full h-96 object-cover"
               :class="{'grayscale opacity-70': (product.stock_num||0) <= 0}">
          <!-- Cinta SIN STOCK -->
          <div x-show="(product.stock_num||0) <= 0"
               class="absolute -right-8 top-3 rotate-45 bg-rose-600 text-white text-xs font-bold px-10 py-1 shadow">
            SIN STOCK
          </div>
        </div>
        <div class="bg-white rounded-2xl shadow-sm border p-5 flex flex-col">
          <h1 class="text-2xl font-bold" x-text="product.nombre"></h1>
          <p class="text-slate-600 mt-1" x-text="product.codigo ? ('Código: '+product.codigo) : ''"></p>
          <p class="text-slate-600" x-text="product.stock_num!=null ? ('Stock: '+product.stock_num) : ''"></p>
          <div class="mt-3 space-y-1">
            <div class="text-2xl font-bold text-emerald-700" x-text="fmtPrice(product.precio_transfer) + ' (Transferencia)'"></div>
            <div class="text-lg font-semibold text-sky-700" x-text="fmtPrice(product.precio_mp) + ' (Mercado Pago)'"></div>
          </div>
          <p class="mt-4 text-slate-700 whitespace-pre-line" x-text="product.descripcion || 'Sin descripción'"></p>

          <div class="mt-auto pt-6 flex gap-2">
            <a href="./" class="flex-1 bg-slate-200 hover:bg-slate-300 rounded-xl px-4 py-2 text-center">Volver</a>
            <button class="flex-1 bg-sky-600 hover:bg-sky-700 text-white rounded-xl px-4 py-2 font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
                    :disabled="(product.stock_num||0) <= 0"
                    @click="addToCart()">
              <span x-show="(product.stock_num||0) > 0">Agregar al carrito</span>
              <span x-show="(product.stock_num||0) <= 0">Sin stock</span>
            </button>
          </div>
        </div>
      </div>
    </template>
  </main>

<script>
function detailApp(){
  const MP_RATE = 1.10;
  function num(v){ if(typeof v==='number') return v; if(v==null) return NaN; let s=String(v).trim().replace(/[^0-9,.-]/g,''); if(s.includes(',')){ s=s.replace(/\./g,''); s=s.replace(/,/g,'.'); } const n=Number(s); return isFinite(n)?n:NaN; }
  function pick(o,ks){ for(const k of ks){ if(o[k]!=null&&o[k]!=='') return o[k]; } }
  return {
    product:null, id:null, loading:true, loadError:false,
    init(){ const p=new URLSearchParams(location.search); this.id=p.get('id'); this.load(); },
    async load(){
      try{
        const res = await fetch('data/productos.xlsx', { cache:'no-store' }); // RUTA RELATIVA
        if(!res.ok){ this.loadError=true; this.loading=false; return; }
        const buf = await res.arrayBuffer(); const wb = XLSX.read(buf,{type:'array'});
        let found=null;
        for(const sheetName of wb.SheetNames){
          const ws = wb.Sheets[sheetName];
          const rows = XLSX.utils.sheet_to_json(ws,{defval:'',raw:true});
          let rowId=1;
          for(const r of rows){
            const row=Object.fromEntries(Object.entries(r).map(([k,v])=>[String(k).toLowerCase().trim(), v]));
            const nombre = pick(row,['nombre','producto','articulo','descri','detalle','item']);
            const precioRaw = pick(row,['precio','$','importe','valor','p. lista','precio feria','precio unitario']);
            const desc = pick(row,['descripcion','detalle','observ']);
            const stockRaw = pick(row,['stock','disp']);
            const imagen = pick(row,['imagen','foto','url']);
            const codigo = pick(row,['codigo','sku','id']);
            const categoria = pick(row,['categoria','rubro','familia']) || sheetName;
            const base = num(precioRaw);

            const stock_num = (()=>{
              if(!stockRaw) return 0;
              const s=String(stockRaw).replace(/[^\d-]/g,'');
              const n=Number(s);
              return Number.isFinite(n)?n:0;
            })();

            if(nombre && !isNaN(base)){
              const rec = {
                __id: sheetName+'-'+(rowId++),
                nombre: String(nombre).trim(),
                precio_transfer: Math.round(base),
                precio_mp: Math.round(base*MP_RATE),
                descripcion: String(desc||'').trim(),
                stock: stockRaw||'',
                stock_num,
                imagen: String(imagen||'').trim(),
                codigo: String(codigo||'').trim(),
                categoria: String(categoria).trim()
              };
              if (rec.__id === this.id){ found = rec; break; }
            }
          }
          if(found) break;
        }
        this.product = found;
      }catch(e){
        this.loadError=true;
      }finally{
        this.loading=false;
      }
    },
    fmtPrice(v){ return Number(v||0).toLocaleString('es-AR',{style:'currency', currency:'ARS', maximumFractionDigits:0}); },
    addToCart(){
      const item = this.product; if(!item) return;
      const cart = JSON.parse(localStorage.getItem('cart')||'[]');
      const idx = cart.findIndex(ci=>ci.__id===item.__id);
      const max = Number(item.stock_num||0);
      if(max<=0){ alert('Sin stock'); return; }
      if (idx>-1){
        const next=(cart[idx].cant||0)+1;
        if(next>max){ alert('No podés superar el stock disponible ('+max+').'); return; }
        cart[idx].cant=next;
      } else {
        cart.push({...item, cant:1});
      }
      localStorage.setItem('cart', JSON.stringify(cart));
      alert('Agregado al carrito');
    },
  }
}
</script>
</body>
</html>
